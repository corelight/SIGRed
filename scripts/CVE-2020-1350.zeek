module CVE_2020_1350;
# This script raises notices relating to the CVE-2020-1350 (AKA SIGRed)
# affecting Windows DNS Server with a CVE score of 10.0
# Tested on zeek 3.2.0-dev.459
# Author: Ben Reardon, Research Team @Corelight. ben.reardon@corelight.com, @benreardon

# Version: 0.1

export {
    redef enum Notice::Type += {
        CVE_2020_1350_detected,
    };
}
# A list of DNS Record types: https://en.wikipedia.org/wiki/List_of_DNS_record_types
# While the primary known attack vector involves the SIG query type (qtype == 25),
# at this stage of development let's select query types that are associated with signatures 
# as these are more likely to be parsed by vulnerable function 
# SIG, KEY, TKEY and RRSIG

# RRSIG (qtype == 46) currently has it's own zeek event
event dns_RRSIG(c: connection, msg: dns_msg, ans: dns_answer, rrsig: dns_rrsig_rr)
    {
    if (|ans| > 65535)
        {
        NOTICE([$note=CVE_2020_1350_detected,
                $conn=c,
                $identifier=cat(c$id$orig_h,c$id$resp_h),
                $msg="CVE-2020-1350 Windows DNS exploit (CVE10) has been detected. Refer to links:  https://cve.mitre.org/cgi-bin/cvename.cgi?name=ALAS-2020-1350 and https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/"]);
        }
    }

# SIG (qtype == 25), KEY (qtype == 24), TKEY (qtype == 249) do not have their own event and so should be parsed by the catch-all event 
event dns_unknown_reply(c: connection, msg: dns_msg, ans: dns_answer)
    {
    if (|ans| > 65535)
        {
        NOTICE([$note=CVE_2020_1350_detected,
                $conn=c,
                $identifier=cat(c$id$orig_h,c$id$resp_h),
                $msg="CVE-2020-1350 Windows DNS exploit (CVE10) has been detected.  Refer to links:  https://cve.mitre.org/cgi-bin/cvename.cgi?name=ALAS-2020-1350 and https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/"]);
        }
    }
